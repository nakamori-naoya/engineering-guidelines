# リレーションシップ設計の手引き

## 🤔 AIが理解に困る典型的な状況

### 1. 非依存リレーションシップの識別

#### 依存性の判断基準
```
エンティティAとBの関係において：

依存関係がある場合：
- Aが存在しないとBも存在できない
- Bの生成時にAが必須

非依存関係の場合：
- AとBは独立して存在可能
- 関係は後から作られる
```

#### 典型的な非依存の例

**例1：社員と部署**
```
❌ 間違い：
社員 (R) {
  社員ID
  部署ID  // NULL可能、配属時に更新
}

✅ 正しい：
社員 (R) {
  社員ID
}

部署 (R) {
  部署ID
}

所属 (E) {
  所属ID
  社員ID
  部署ID
  配属日
}
```

**例2：商品とカテゴリ**
```
❌ 間違い：
商品 (R) {
  商品ID
  カテゴリID  // 後から分類変更あり
}

✅ 正しい：
商品カテゴリ分類 (E) {
  分類ID
  商品ID
  カテゴリID
  分類日時
}
```

### 2. 時系列の逆転問題

#### 問題の識別
```
イベントの発生順序：
1. 注文発生
2. 請求作成

データモデル：
注文 (E) {
  注文ID
  請求ID  // 注文時点では未定
}
```

#### 解決方法
```
注文 (E) {
  注文ID
  // 請求IDは持たない
}

請求 (E) {
  請求ID
}

請求明細 (E) {
  明細ID
  請求ID
  注文ID
}
```

### 3. 多対多関係の扱い

#### 単純な多対多
```
// 学生と授業の関係
履修 {
  学生ID
  授業ID
  履修日時  // イベントとして扱う
}
```

#### 属性を持つ多対多
```
// 従業員とプロジェクトの関係
プロジェクト参加 (E) {
  参加ID
  従業員ID
  プロジェクトID
  役割
  参加開始日
  参加終了日
}
```

## 💡 設計のコツ

### カーディナリティの見極め

#### 現在の関係 vs 将来の可能性
```
現在：1対1
将来：1対多の可能性

→ 最初から1対多で設計
```

#### 0..1 の扱い
```
// 0または1の関係
ユーザー (R) {
  ユーザーID
}

プレミアム会員 (R) {
  ユーザーID  // PKかつFK
  プレミアム開始日
}
```

### 関係の変化を記録

#### 関係の履歴が重要な場合
```
// 担当者の変遷を追跡
顧客担当 (E) {
  担当ID
  顧客ID
  担当者ID
  担当開始日
  担当終了日
}
```

#### 最新の関係のみ重要な場合
```
// 現在の設定値のみ
ユーザー設定 {
  ユーザーID
  設定項目ID
  設定値
}
```

### 循環参照の回避

#### 問題のあるパターン
```
部署 → 部署長（社員）
 ↑        ↓
 └─ 所属 ←─┘
```

#### 解決策
```
部署 (R) {
  部署ID
}

社員 (R) {
  社員ID
}

所属 (E) {
  社員ID
  部署ID
}

部署長任命 (E) {
  部署ID
  社員ID
  任命日
}
```

## ⚠️ よくある間違い

### 1. 安易な外部キー
```
❌ 間違い：
すべての関係を外部キーで表現
→ NULL多発、更新多発

✅ 正しい：
非依存は交差エンティティ
```

### 2. 関係の向き
```
❌ 間違い：
親子関係で子が親のIDを持つ
（実は多対多だった）

✅ 正しい：
関係性を正確に分析
```

### 3. 削除の連鎖
```
❌ 間違い：
CASCADE DELETE で連鎖削除
→ 意図しないデータ消失

✅ 正しい：
論理削除または
削除不可制約
```

### 4. パフォーマンス軽視
```
❌ 間違い：
正規化のみ重視
→ JOIN地獄

✅ 正しい：
適切な非正規化も検討
```

## 🔍 チェックリスト

リレーションシップ設計の確認事項：

- [ ] 依存/非依存を正しく判断したか
- [ ] 時系列の逆転がないか確認したか
- [ ] NULL可能な外部キーがないか
- [ ] 多対多関係を適切に表現したか
- [ ] 関係の変化を記録する必要性を検討したか
- [ ] 循環参照がないか確認したか
- [ ] 削除時の影響を考慮したか
- [ ] パフォーマンスを考慮したか

## 📝 パターン集

### 階層構造
```
// 自己参照
組織 (R) {
  組織ID
  親組織ID  // NULL可能
}

// または閉包テーブル
組織階層 {
  祖先組織ID
  子孫組織ID
  階層深度
}
```

### 排他的関係
```
// 支払い方法（現金/カード/振込）
支払い (E) {
  支払いID
  支払い方法区分
}

現金支払い (E) {
  支払いID
  受取金額
}

カード支払い (E) {
  支払いID
  カード番号下4桁
  承認番号
}
```

### ポリモーフィック関連の回避
```
❌ 避けるべき：
コメント {
  対象種別  // '記事' or '商品'
  対象ID    // 記事IDまたは商品ID
}

✅ 推奨：
記事コメント {
  記事ID
  コメント内容
}

商品コメント {
  商品ID
  コメント内容
}
```