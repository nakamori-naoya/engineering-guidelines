# SQLアンチパターン回避ガイドライン

本ドキュメントは、Bill Karwin著「SQL Antipatterns」に基づき、データベース設計において回避すべきアンチパターンと推奨される設計パターンを定めたものである。

## 🎯 基本原則

### アンチパターンの認識
データベース設計における「良かれと思って行う誤った慣習」を認識し、適切な設計パターンを選択する。

### 設計の指針
1. **正規化の原則を尊重** - 適切な正規化レベルを維持する
2. **制約の活用** - データベースの制約機能を積極的に使用する
3. **シンプルさの追求** - 複雑な回避策より標準的な解決策を選ぶ

## 📊 論理設計のアンチパターン

### 1. ジェイウォーク（信号無視）
カンマ区切りリストで複数の値を格納することを避ける。

**避けるべき設計**
- 単一カラムに複数のIDをカンマ区切りで格納
- 文字列操作での検索・更新

**推奨される設計**
- 交差テーブルを用いた多対多の関係表現
- 適切な正規化による設計

### 2. ナイーブツリー（素朴な木）
階層構造を隣接リストのみで表現することを避ける。

**避けるべき設計**
- parent_idのみでの階層表現
- 再帰的なクエリの多用

**推奨される設計**
- 経路列挙モデル
- 入れ子集合モデル
- 閉包テーブル

### 3. ID リクワイアド（とりあえずID）
すべてのテーブルに機械的にIDカラムを追加することを避ける。

**避けるべき設計**
- 自然キーが存在するのに代理キーを強制
- 複合主キーを避けるためだけのID追加

**推奨される設計**
- 自然キーが安定している場合は活用
- 複合主キーが適切な場合は採用

### 4. キーレスエントリ（外部キー嫌い）
外部キー制約を使用しないことを避ける。

**避けるべき設計**
- アプリケーション側のみでの参照整合性管理
- 外部キー制約の省略

**推奨される設計**
- 外部キー制約の積極的な使用
- カスケードオプションの適切な設定

### 5. EAV（エンティティ・アトリビュート・バリュー）
汎用的な属性テーブルの使用を避ける。

**避けるべき設計**
- すべての属性を行として格納
- 型安全性の喪失

**推奨される設計**
- 具体的なカラムでの属性定義
- 必要に応じたサブタイプの使用

### 6. ポリモーフィック関連
複数のテーブルを参照する外部キーを避ける。

**避けるべき設計**
- entity_typeとentity_idの組み合わせ
- 参照整合性の保証不可

**推奨される設計**
- 個別の関連テーブル
- 共通の基底テーブルとの関連

## 🔧 物理設計のアンチパターン

### 7. マルチカラムアトリビュート
繰り返し項目のカラムを避ける。

**避けるべき設計**
- tag1, tag2, tag3のような連番カラム
- 固定数の繰り返し項目

**推奨される設計**
- 別テーブルでの1対多関係
- 適切な正規化

### 8. メタデータトリブル（メタデータ大増殖）
テーブルや列の複製を避ける。

**避けるべき設計**
- 年別・月別テーブルの作成
- 同一構造のテーブル複製

**推奨される設計**
- パーティショニングの活用
- 単一テーブルでの管理

## 🔍 クエリのアンチパターン

### 9. フィア・オブ・ジ・アンノウン（NULLの恐怖）
NULL値の誤った扱いを避ける。

**避けるべき設計**
- NULLの代わりに空文字列や0を使用
- NULL比較の誤り

**推奨される設計**
- NULLの適切な使用
- IS NULL/IS NOT NULLでの比較

### 10. アンビギュアスグループ（曖昧なグループ）
GROUP BYの誤用を避ける。

**避けるべき設計**
- 集約されていないカラムの選択
- 単一値の前提

**推奨される設計**
- 完全な関数従属性の保証
- ウィンドウ関数の活用

### 11. ランダムセレクション
非効率なランダム行選択を避ける。

**避けるべき設計**
- ORDER BY RAND()の使用
- 全行スキャン

**推奨される設計**
- 事前計算されたランダム値
- サンプリング手法の活用

### 12. プアマンズサーチエンジン（貧者のサーチエンジン）
LIKEでの全文検索を避ける。

**避けるべき設計**
- LIKE '%keyword%'の多用
- 複数カラムのOR結合

**推奨される設計**
- 全文検索インデックスの使用
- 専用の検索エンジン活用

## 💻 アプリケーション開発のアンチパターン

### 13. スパゲッティクエリ
過度に複雑なクエリを避ける。

**避けるべき設計**
- 1つのクエリですべてを解決
- 深いネストと多数のJOIN

**推奨される設計**
- クエリの分割
- 共通テーブル式（CTE）の活用

### 14. インプリシットカラム（暗黙の列）
SELECT *の使用を避ける。

**避けるべき設計**
- すべてのクエリでSELECT *
- カラム追加時の影響

**推奨される設計**
- 必要なカラムの明示的指定
- カラムリストの管理

### 15. リーダブルパスワード（読み取り可能パスワード）
パスワードの平文保存を避ける。

**避けるべき設計**
- 平文でのパスワード保存
- 弱い暗号化

**推奨される設計**
- 適切なハッシュ関数の使用
- ソルトの付加

### 16. SQLインジェクション
文字列結合によるクエリ構築を避ける。

**避けるべき設計**
- 文字列結合でのSQL生成
- 入力値の直接埋め込み

**推奨される設計**
- プリペアドステートメントの使用
- パラメータバインディング

### 17. シュードキー・ニートフリーク（擬似キー潔癖症）
連番の欠番を埋めることを避ける。

**避けるべき設計**
- 欠番の再利用
- 連番の付け直し

**推奨される設計**
- 欠番の許容
- 代理キーの本質理解

### 18. シー・ノー・エビル（臭いものに蓋）
エラー処理の無視を避ける。

**避けるべき設計**
- エラーの握りつぶし
- 汎用的なエラー処理

**推奨される設計**
- 適切なエラーハンドリング
- エラーログの記録

### 19. ディプロマティック・イミュニティ（外交特権）
過度なSQL権限付与を避ける。

**避けるべき設計**
- 全ユーザーへの管理者権限
- 必要以上の権限付与

**推奨される設計**
- 最小権限の原則
- ロールベースのアクセス制御

### 20. マジックビーンズ（魔法の豆）
モデルとアクティブレコードの混同を避ける。

**避けるべき設計**
- ドメインロジックのモデルへの詰め込み
- データベース依存の設計

**推奨される設計**
- 責務の分離
- ドメインモデルとデータモデルの区別

## 🔄 設計プロセス

1. **要件分析** - ビジネス要件の正確な理解
2. **アンチパターン確認** - 既知のアンチパターンとの照合
3. **設計選択** - 推奨パターンからの選択
4. **レビュー** - アンチパターンの混入確認
5. **リファクタリング** - 継続的な改善

---

## 📝 アンチパターン例

### ジェイウォークの例
```sql
-- 悪い例
CREATE TABLE products (
  product_id INT PRIMARY KEY,
  tag_list VARCHAR(255)  -- 'tag1,tag2,tag3'
);

-- 良い例
CREATE TABLE product_tags (
  product_id INT,
  tag_id INT,
  PRIMARY KEY (product_id, tag_id),
  FOREIGN KEY (product_id) REFERENCES products(product_id),
  FOREIGN KEY (tag_id) REFERENCES tags(tag_id)
);
```

### EAVの例
```sql
-- 悪い例
CREATE TABLE attributes (
  entity_id INT,
  attribute_name VARCHAR(255),
  attribute_value VARCHAR(255)
);

-- 良い例
CREATE TABLE products (
  product_id INT PRIMARY KEY,
  name VARCHAR(255),
  price DECIMAL(10,2),
  weight DECIMAL(8,3)
);
```

---

本ガイドラインに従うことで、保守性が高く、パフォーマンスに優れたデータベース設計を実現する。